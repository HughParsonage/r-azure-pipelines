parameters:
  args: '--no-manual'
  cache: true
  coverage: true

steps:
  - bash: |
      echo 'options(repos = "$(CRAN)", Ncpus = 2)' > ~/.Rprofile
      mkdir -p $(R_LIBS_USER)
    displayName: "Setting up Unix R library"
  - ${{ if eq(parameters.coverage, 'true') }}:
      - task: CacheBeta@0
        inputs:
          key: |
            ./DESCRIPTION
            "$(containerImage)"
          path: $(R_LIBS_USER)
        displayName: 'Caching Packages'
  - bash: |
      Rscript -e "install.packages(c('remotes', 'rcmdcheck'))"
      Rscript -e "remotes::install_deps(dependencies = TRUE)"
    displayName: 'Install package dependencies'
  - bash: |
      Rscript -e "rcmdcheck::rcmdcheck(args = ${{parameters.args}}, error_on = 'error', check_dir = 'check')"
    displayName: 'Check package'
  - task: PublishTestResults@1
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: 'check/*.Rcheck/tests/test-*.xml'
  - publish: check
    artifact: $(Build.BuildId)-check_results
  - ${{ if eq(parameters.coverage, 'true') }}:
      - bash: |
          Rscript -e "cov <- covr::package_coverage()" -e "covr::to_cobertura(cov, 'coverage.xml')"
        displayName: 'Run code coverage'
      - task: PublishCodeCoverageResults@1
        inputs:
          codeCoverageTool: 'Cobertura'
          summaryFileLocation: 'coverage.xml'
